-- Create database and use it
CREATE DATABASE library;
USE library;

-- Create Borrower table
CREATE TABLE Borrower (
    Rollno INT(4),
    Name VARCHAR(20),
    DateofIssue DATE,
    NameofBook VARCHAR(30),
    Status VARCHAR(10)
);

-- Insert sample data into Borrower
INSERT INTO Borrower VALUES (14, 'Ram', '2022-09-19', 'Operating System', 'I');
INSERT INTO Borrower VALUES (27, 'Soham', '2022-07-24', 'Object Oriented Programming', 'I');
INSERT INTO Borrower VALUES (34, 'Mohan', '2022-06-12', 'Microprocessor', 'I');
INSERT INTO Borrower VALUES (48, 'Om', '2022-04-19', 'Mechanics', 'I');

-- View Borrower table
SELECT * FROM Borrower;

-- Create Fine table
CREATE TABLE Fine (
    Rollno INT(4),
    Date DATE,
    Amount INT(10)
);

-- Create procedure to calculate fine
DELIMITER //

CREATE PROCEDURE calc_Fine(IN r INT, IN b VARCHAR(30))
BEGIN
    DECLARE doi DATE;
    DECLARE diff INT;

    -- Get Date of Issue
    SELECT DateofIssue INTO doi 
    FROM Borrower 
    WHERE Rollno = r AND NameofBook = b;

    -- Calculate difference in days
    SELECT DATEDIFF(CURDATE(), doi) INTO diff;

    -- Insert fine based on difference
    IF diff >= 15 AND diff <= 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 5);
    ELSEIF diff > 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 50);
    END IF;
END //

-- Create procedure to submit books
CREATE PROCEDURE submit(IN r INT)
BEGIN
    -- Update Borrower status
    UPDATE Borrower SET Status = 'R' WHERE Rollno = r;

    -- Delete fines for this borrower
    DELETE FROM Fine WHERE Rollno = r;
END //

DELIMITER ;

-- Calculate fines for borrowers
CALL calc_Fine(14, 'Operating System');
CALL calc_Fine(27, 'Object Oriented Programming');
CALL calc_Fine(34, 'Microprocessor');
CALL calc_Fine(48, 'Mechanics');

-- View Fine table after calculation
SELECT * FROM Fine;

-- Submit books (return)
CALL submit(14);
CALL submit(27);
CALL submit(48);
CALL submit(34);

-- View final Fine and Borrower tables
SELECT * FROM Fine;
SELECT * FROM Borrower;
